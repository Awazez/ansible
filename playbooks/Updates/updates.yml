---
# =============================================================================
#  Author : Martin AUBEUT
#  Ansible Playbook — Mise à jour système complète
#  Usage : ansible-playbook -i inventory.ini updates.yml
#  Version : 1.0 (2025-19-02)
#  Modification :
#  - 2025-19-02 - Initial version
# =============================================================================

- name: System updates
  hosts: all
  become: true

  tasks:
    - name: Update apt cache
      apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Upgrade all packages
      apt:
        upgrade: dist
      register: upgrade_result

    - name: Remove unused dependencies
      apt:
        autoremove: true
        purge: true

    - name: Clean apt cache
      apt:
        autoclean: true

    - name: Check if reboot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Reboot if required
      reboot:
        msg: "Reboot triggered by Ansible after system upgrade"
        reboot_timeout: 300
      when: reboot_required.stat.exists