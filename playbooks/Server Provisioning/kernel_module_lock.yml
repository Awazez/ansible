---
- name: Disable kernel module loading after boot
  hosts: all
  become: true

  # ATTENTION : kernel.modules_disabled=1 est IRRÉVERSIBLE sans reboot.
  # Une fois activé, aucun nouveau module ne peut être chargé jusqu'au prochain boot.
  # S'assurer que tous les modules nécessaires sont déjà chargés (netbird, etc.)

  tasks:
    - name: Check currently loaded modules before locking
      command: lsmod
      register: loaded_modules
      changed_when: false

    - name: Display loaded modules (vérification manuelle recommandée)
      debug:
        msg: "{{ loaded_modules.stdout_lines | length }} modules actuellement chargés"

    - name: Disable kernel module loading (irréversible sans reboot)
      sysctl:
        name: kernel.modules_disabled
        value: '1'
        state: present
        reload: true
        sysctl_file: /etc/sysctl.d/99-hardening.conf